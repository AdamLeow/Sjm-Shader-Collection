# 《Unity Shader 入门精要》读书笔记 之 纹理映射 #
## 参考资料 ##
> 《Unity Shader 入门精要》
## 法线映射 ##
### 疑难解答 ###
#### 获得世界空间下的顶点坐标 ####
这是对我以往的Bug写法的修正，在以前，我用

	o.worldPos = UnityObjectToWorldDir(v.vertex)

来计算在世界空间下的顶点坐标，但这是**不正确的写法！！！**
因为UnityObjectToWorldDir函数是对方向矢量进行变换（即只具有方向的向量），而这里我们要变换的是顶点并不是方向矢量。

正确的变换模型空间的顶点到世界坐标的方法还是要老老实实用矩阵乘法来完成，如下所示：

	o.worldPos = mul(unity_ObjectToWorld,v.vertex).xyz;
unity_ObjectToWorld是模型-世界空间的变换矩阵。

#### 法线贴图如何存储法线？如何在Shader中取出法线? ####

**一 法线纹理如何存储法线？**

法线纹理存储的就是表面的法线的方向。由于法线方向分量在[-1,1]，而像素分量为[0,1]。

所以对法线做一个映射，将其压缩为一个像素，存储到法线纹理中，映射公式如下：

pixel = (normal+1) / 2

**二 如何在Shader中取出法线？**

对于在Unity中标注好类型是Normal Map的贴图,可以直接使用unity内置函数UnpackNormal()来取出并解析法线纹理中的法线.

对于没有标注类型是Normal Map的贴图,可以直接手工模拟这个过程,即:

normal = pixel*2 - 1

#### 法线贴图中法线的方向 ####
任何不谈坐标空间的方向都是在耍流氓！

法线纹理中存储的法线有两种坐标空间，一是定义在模型空间的表面法线，在纹理中所有法线的方向都基于模型空间。所有法线所在的坐标空间是同一个坐标空间。  
二是模型顶点的切线空间，此切线空间以**该顶点为坐标轴原点**，**以法线为z轴**，**以切线为x轴**，**以副切线为y轴**。所有法线所在的坐标空间都是不同的坐标空间。（都是各自顶点的坐标空间）

以切线空间来存储法线的法线纹理多半都是浅蓝色的。这是因为如果一个法线没有变化，那么他在法线纹理中存储的向量值应该（0，0，1）（法线在切线空间的x轴），他的像素值应该是（0.5,0.5,1），所以整个法线纹理会看到是浅蓝色的。

实际上，这种存储方式其实就是存储了每个点在各自的切线空间中的法线的扰动方向。

**在实际运用中，最经常用到的是以切线空间来存储各个法线的方向。**

#### 如何构建切线-世界空间变换矩阵 or 顶点-切线空间变换矩阵 ####
在Shader编程中，实际上从法线纹理中取出的法线坐标是该法线在当前顶点的切线空间下的坐标表示。要实际使用此法线，需要统一坐标空间进行运算。

可行的方案有两个，一是在切线空间下完成各类光照的计算，二是将得到的切线空间下的法线转变为世界空间坐标下的法线。

方案2更加灵活，在这里采用方案2来进行计算。

那么问题就转换为了，如何构建一个 **切线-世界空间变换矩阵** 来使得切线空间下的法线变换为世界坐标下的法线。下面按以下步骤构建变换矩阵。

**一、** 已知切线空间的z轴（当前顶点的法线）、x轴（当前顶点的切线）、y轴（当前顶点的副切线）在世界坐标下的表示。

**二、** 根据《Unity Shader 入门精要》4.6节的描述 可以将x轴、y轴、z轴的另一空间下的坐标表示按列或行摆放，形成变换矩阵。

**那么究竟是按列摆放还是按行摆放呢？**

***冷静分析***

（T为切线空间，W为世界空间）
已知坐标空间T、W以及坐标空间T的3个坐标轴在坐标空间W下的表示Xt(世界空间的切线)、Yt（世界空间的副切线）、Zt（世界空间的法线），以及原点位置Ot。

给定一个点At = (a,b,c)在坐标空间T下的表示，求解点A在坐标空间W下的表示Aw。

Aw = Ot + a * Xt + b * Yt + c * Zt

经过推导，其变换矩阵为：

![Avater](./Image/readmeImage/texture1.png)

故可以知道，将切线空间的x、y、z轴按列摆放即可形成变换矩阵。

分析规律，当要计算变换矩阵M（T→W）时，需要知道T的三个坐标轴在W空间下的表示。

***快速分析***

当不知道构造变换矩阵要将x,y,z轴是按列摆放还是按行摆放时，一个快速的分析方法是，直接都试一遍。然后根据一个简单的验证方法验证这次尝试的变换矩阵是否正确。

这个验证方法就是，如果我们得到的变换矩阵（其切线-世界变换矩阵）是正确的，那么，使用这个变换矩阵去变换(1,0,0)（在T空间下x轴的坐标表示）一定会得到的值是[——Xt——]，这是因为在W空间下，T空间x轴的坐标表示已经在前文给出，也就是[——Xt——]。

简单举个例子：

先尝试按行摆放来构造变换矩阵。

![Avater](./Image/readmeImage/texture2.png)

可以发现答案并不是预期的[——Xt——],说明此变换矩阵是不正确的。

在尝试按列摆放来构造变换矩阵。

![Avater](./Image/readmeImage/texture3.png)

可以发现结果正确，经过变换后的x轴坐标在世界坐标空间下表示为[——Xt——]。

## 渐变纹理	
渐变纹理即一张一维的纹理，主要用来更加细微地控制物体的漫反射光照。

在实际使用中，一般使用半兰伯特光照模型的数学公式来对渐变纹理进行采样。表示式如下所示：

	0.5*dot(worldNormal,worldLightDir)+0.5）

### 为什么要使用半兰伯特表达式进行采样
个人理解，这要从半兰伯特表示式的意义说起，此公式用于表示某点的辐照度（即光照强度），值域为[0,1]。

使用该公式来对纹理进行采样，就表示按照光照强度对一个一维纹理进行采样。


