# 《Unity Shader 入门精要》读书笔记 之 立方体纹理、GrabPass #
## 参考资料 ##
> 《Unity Shader 入门精要》  
> Unity Shader-反射效果 https://blog.csdn.net/puppet_master/article/details/80808486
## 立方体纹理
与普通的2D纹理不同，立方体纹理包含6个图像，分别表示立方体的5个面。

当要对立方体纹理进行采样时，提供一个方向向量，该向量从立方体纹理中心出发并无限延伸，直到与立方体6个纹理之一相交，采样的结果即交点。

采样原理如下图所示：

![Avater]()

### 反射
基于立方体纹理可以方便的实现反射效果，该Shader的关键函数如下：

    float3 reflect(float3 i,float3 n)

表示计算入射光线i关于法向量n的反射方向。reflect函数的原理如下所示(注意该公式的所有向量均为单位向量)：

    r = 2(n·l)n-l

实现反射效果的步骤如下：

1. 根据当前环境生成CubeMap贴图
2. shader根据反射方向对CubeMap进行采样

关键代码：

    float3 reflection = reflect(-o.worldViewDir,o.worldNormal);

其原理是：

> 物体反射到摄像机中的光线方向，可以由光路可逆的原则来方向求得。也就是说，可以计算视角方向关于顶点法线的反射方向来求得如入射光线的方向。

关键代码各向量方向如下图所示：

![Avater]()

**概括一下**，**个人理解**，反射就是，当我们对一个能对周围进行反射的物体（如金属材质物体）进行观测时，可以通过反射看到它前方的物体。一个最为典型的例子就是——**镜子**，当我们观察镜子的时候，因为反射的作用，所以我们可以完全观察到我们自身。

#### 间接光照和直接光照

> 反射，应该属于间接光照的范畴，而非直接光照。我们正常计算光的dot（N，L）或者dot（H，N）时计算的均为直接光照，光源出发经过物体表面该像素点反射进入眼睛的光照。然而这只是一部分，该点还可以接受来自场景中所有其他点反射的光照，如果表面光滑，则表面就可以反射周围的环境（如镜面，金属），到那时这个计算相当复杂，相当于需要在该点法线方向对应的半球空间上做积分运算才可能计算完全的间接光照，而且光线与物体碰撞后并不会消亡，而是经过反射或折射，改变方向后继续传递，相当于无限递归
原文：https://blog.csdn.net/puppet_master/article/details/80808486 

### 折射
当我们从一个介质透过另一个介质观察其中的物体时，会发现其中的图像产生了扭曲的情况，这就是光线折射的表现。

举个例子，当我们看一个筷子在水中的表现时，会发现筷子未浸水的部分表现正常，浸入水的部分出现了明显的弯曲。这就是因为光在水和空气的折射率不同，光线在通过空气斜射入水中时，发生了折射现象。

折射的定义：

> 当光线从一种介质（如空气）斜射入另一种介质（如玻璃）时，传播方向一般会发生改变。

概括一下，**个人理解**，折射就是，当我们观测一个光线进入其中会发生折射的物体（即具有折射特性材质的物体）时（如水面），会发现透过该物体，在该物体后方的图像被扭曲了。

折射关键函数为refract函数，其方法签名如下：

    fixed3 refract(fixed3 i,fixed3 n,fixed eta);

其中i为入射光线，n为入射光线的法线，eta为两个介质折射率的比值，如真空折射率为1，玻璃折射率为1.5，则折射比为1/1.5。需要注意的是，其中i和n都必须为**单位向量**。

基于CubeMap也可以快速做出折射效果，基本原理是，其实现步骤如下：

1. 根据当前环境生成CubeMap贴图
2. 基于refract函数计算经过折射后的向量，根据此向量对CubeMap进行采样